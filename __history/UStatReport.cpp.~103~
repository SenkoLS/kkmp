//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "UStatReport.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "DBAxisGridsEh"
#pragma link "DBGridEh"
#pragma link "DBGridEhGrouping"
#pragma link "DBGridEhToolCtrls"
#pragma link "DynVarsEh"
#pragma link "GridsEh"
#pragma link "ToolCtrlsEh"
#pragma resource "*.dfm"
TFStatReport *FStatReport;
//---------------------------------------------------------------------------
__fastcall TFStatReport::TFStatReport(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TFStatReport::ChBoxOfficeClick(TObject *Sender)
{
	if(ChBoxGeneral->Checked == true){
		ChBoxGeneral->Checked = false;
	}else{
		if( ChBoxOffice->Checked == false &&
			ChBoxExpert->Checked == false &&
			ChBoxMed->Checked == false){

			ChBoxGeneral->Checked = true;
		}
	}

	if(ChBoxOffice->Checked){
		DBLCbOffice->Enabled = true;
		DMAvtoriz->SQLQgetListOffice->Close();
		DMAvtoriz->SQLQgetListOffice->Open();
		DMAvtoriz->CDSgetListOffice->Close();
		DMAvtoriz->CDSgetListOffice->Open();
	}else{
		DBLCbOffice->Enabled = false;
		DMAvtoriz->SQLQgetListOffice->Close();
		DMAvtoriz->CDSgetListOffice->Close();
	}
}
//---------------------------------------------------------------------------

void __fastcall TFStatReport::ChBoxExpertClick(TObject *Sender)
{
	if(ChBoxGeneral->Checked == true){
		ChBoxGeneral->Checked = false;
	}else{
		if( ChBoxOffice->Checked == false &&
			ChBoxExpert->Checked == false &&
			ChBoxMed->Checked == false){

			ChBoxGeneral->Checked = true;
		}
	}

	if(ChBoxExpert->Checked){
		DBLCbExpert->Enabled = true;
		DMAvtoriz->SQLQGetListMed->Close();
		DMAvtoriz->SQLQGetListMed->Open();
		DMAvtoriz->CDSGetListMed->Close();
		DMAvtoriz->CDSGetListMed->Open();
	}else{
		DBLCbExpert->Enabled = false;
		DMAvtoriz->SQLQGetListMed->Close();
		DMAvtoriz->CDSGetListMed->Close();
	}
}
//---------------------------------------------------------------------------

void __fastcall TFStatReport::ChBoxMedClick(TObject *Sender)
{
	if(ChBoxGeneral->Checked == true){
		ChBoxGeneral->Checked = false;
	}else{
		if( ChBoxOffice->Checked == false &&
			ChBoxExpert->Checked == false &&
			ChBoxMed->Checked == false){

			ChBoxGeneral->Checked = true;
		}
	}

	if(ChBoxMed->Checked){
		DBLCbMed->Enabled = true;
		DMAvtoriz->SQLQGetListMedStat->Close();
		DMAvtoriz->SQLQGetListMedStat->Open();
		DMAvtoriz->CDSGetListMedStat->Close();
		DMAvtoriz->CDSGetListMedStat->Open();
	}else{
		DBLCbMed->Enabled = false;
		DMAvtoriz->SQLQGetListMedStat->Close();
		DMAvtoriz->CDSGetListMedStat->Close();
	}
}
//---------------------------------------------------------------------------

void __fastcall TFStatReport::BGenerateReportClick(TObject *Sender)
{
    int mess = MessageBox(0,L"Вы хотите распечатать отчет в EXCEL?",L"Сообщение",MB_YESNO | MB_ICONQUESTION);
	if(mess != 6) return;

	if(ECountOfVisits->Text.IsEmpty()){
		MessageBox(0,L"Не указано количество посещений\nза отчетный период!",L"Ошибка",MB_OK | MB_ICONHAND);
		ECountOfVisits->SetFocus();
		return;
	}

	try{
     	StrToInt(ECountOfVisits->Text);
	}catch(...){
		MessageBox(0,L"Количество посещений за отчетный период\nне является целым числом!\nИсправьте значение.",L"Ошибка",MB_OK | MB_ICONHAND);
		ECountOfVisits->SetFocus();
		return;
	}

	Variant  vVarApp,vVarBooks,vVarBook, vVarSheets,vVarSheet,vVarCell;
	UnicodeString dir_cards;
	AnsiString dir;

	if(SelectDirectory("Выберите папку для сохранения протокола:","",dir_cards)){
		dir = dir_cards+"\\";
		dir = dir + "ОТЧЕТ.xls";
	}

	try{
		vVarApp=CreateOleObject("Excel.Application");
		vVarApp.OlePropertySet("Visible",true);
		vVarBooks=vVarApp.OlePropertyGet("Workbooks");
		vVarApp.OlePropertySet("SheetsInNewWorkbook",2);
		vVarBooks.OleProcedure("Add");
		vVarBook=vVarBooks.OlePropertyGet("Item",1);
		vVarSheets=vVarBook.OlePropertyGet("Worksheets") ;
	}catch(Exception &e){
		MessageBox(0,e.Message.c_str(),L"Ошибка создания EXCEL:",MB_OK | MB_ICONERROR);
		return;
	}

	//----- GET TYPE QUERY -----------------------------------------------------
	AnsiString typeQuery = "";

	if(ChBoxOffice->Checked && ChBoxExpert->Checked && ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` INNER JOIN `user` INNER JOIN `office` "
			"ON `inspection`.`id_user` = `user`.`id_user` AND `user`.`id_office` = `office`.`id_office` "
			"WHERE `office`.`id_office` = '" +DBLCbOffice->ListSource->DataSet->FieldByName("id_office")->AsAnsiString+ "' AND "
			"`inspection`.`id_expert` = '" +DBLCbExpert->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`inspection`.`id_user` = '" +DBLCbMed->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	if(ChBoxOffice->Checked && ChBoxExpert->Checked && !ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` INNER JOIN `user` INNER JOIN `office` "
			"ON `inspection`.`id_user` = `user`.`id_user` AND `user`.`id_office` = `office`.`id_office` "
			"WHERE `office`.`id_office` = '" +DBLCbOffice->ListSource->DataSet->FieldByName("id_office")->AsAnsiString+ "' AND "
			"`inspection`.`id_expert` = '" +DBLCbExpert->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	if(ChBoxOffice->Checked && !ChBoxExpert->Checked && ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` INNER JOIN `user` INNER JOIN `office` "
			"ON `inspection`.`id_user` = `user`.`id_user` AND `user`.`id_office` = `office`.`id_office` "
			"WHERE `office`.`id_office` = '" +DBLCbOffice->ListSource->DataSet->FieldByName("id_office")->AsAnsiString+ "' AND "
			"`inspection`.`id_user` = '" +DBLCbMed->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	if(ChBoxOffice->Checked && !ChBoxExpert->Checked && !ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` INNER JOIN `user` INNER JOIN `office` "
			"ON `inspection`.`id_user` = `user`.`id_user` AND `user`.`id_office` = `office`.`id_office` "
			"WHERE `office`.`id_office` = '" +DBLCbOffice->ListSource->DataSet->FieldByName("id_office")->AsAnsiString+ "' AND "
			"`date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	if(!ChBoxOffice->Checked && ChBoxExpert->Checked && ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` "
			"WHERE `inspection`.`id_expert` = '" +DBLCbExpert->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`inspection`.`id_user` = '" +DBLCbMed->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	if(!ChBoxOffice->Checked && ChBoxExpert->Checked && !ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` "
			"WHERE `inspection`.`id_expert` = '" +DBLCbExpert->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	if(!ChBoxOffice->Checked && !ChBoxExpert->Checked && ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` "
			"WHERE `inspection`.`id_user` = '" +DBLCbMed->ListSource->DataSet->FieldByName("id_user")->AsAnsiString+ "' AND "
			"`date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	if(!ChBoxOffice->Checked && !ChBoxExpert->Checked && !ChBoxMed->Checked){
		typeQuery =
			"SELECT * FROM `inspection` "
			"WHERE `date_end` BETWEEN '" +FormatDateTime("yyyy-mm-dd",DTPStartReportPer->DateTime)+ "' AND '"
			+ FormatDateTime("yyyy-mm-dd",DTPEndReportPer->DateTime) +"'";
	}

	//----- GET DATA THE COUNT CARD---------------------------------------------
		DMAvtoriz->SQLQInspection->Close();
		DMAvtoriz->SQLQInspection->SQL->Text = typeQuery;
		DMAvtoriz->SQLQInspection->Open();
		DMAvtoriz->CDSInspection->Close();
		DMAvtoriz->CDSInspection->Open();
	//----------------------------------------------------------------------

	int count1,count2,count3,count4,count5,count6,count7,count8,count9,
		count10,count11,count12,count13,count14,count15,count16,count17,count18,
		count19,count20,count21 = 0;

	VuluntarMedAgreementYes, AgreementPDNYes,
	ComplitListDeseaseYes, CompitListProfAndStatusYes,
	ExistenceFLGYes, ExistenceInspGinYes,
	RationalUseOfResourcesYes, AbsenceComplaintsOfPatientsYes,
	TimelyRegistLNYes,RefferalToVKYes,
	IntegrityCard, AccuracyHandwriting,
	QualityProfInsOnko, DispTimelines,
	QualityCollectAnamsis, QualityCollectComplaint,
	DescriptObjectStatus, EvaluationResultsOfTreatment,
	ObservStandartsOfDiagnostics, ObservStandartsOfTreatment,
	DeadlinesVN = 0;

	//GPA
	while(!DMAvtoriz->DSInspection->DataSet->Eof){
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("VuluntarMedAgreementYes")->AsInteger != 0){
			VuluntarMedAgreementYes += DMAvtoriz->DSInspection->DataSet->FieldByName("VuluntarMedAgreementYes")->AsInteger;
			count1++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("AgreementPDNYes")->AsInteger != 0){
			AgreementPDNYes += DMAvtoriz->DSInspection->DataSet->FieldByName("AgreementPDNYes")->AsInteger;
			count2++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("ComplitListDeseaseYes")->AsInteger != 0){
			ComplitListDeseaseYes += DMAvtoriz->DSInspection->DataSet->FieldByName("ComplitListDeseaseYes")->AsInteger;
			count3++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("CompitListProfAndStatusYes")->AsInteger != 0){
			CompitListProfAndStatusYes += DMAvtoriz->DSInspection->DataSet->FieldByName("CompitListProfAndStatusYes")->AsInteger;
			count4++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("CompitListProfAndStatusYes")->AsInteger != 0){
			ExistenceFLGYes += DMAvtoriz->DSInspection->DataSet->FieldByName("ExistenceFLGYes")->AsInteger;
			count5++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("ExistenceInspGinYes")->AsInteger != 0){
			ExistenceInspGinYes += DMAvtoriz->DSInspection->DataSet->FieldByName("ExistenceInspGinYes")->AsInteger;
			count6++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("RationalUseOfResourcesYes")->AsInteger != 0){
			RationalUseOfResourcesYes += DMAvtoriz->DSInspection->DataSet->FieldByName("RationalUseOfResourcesYes")->AsInteger;
			count7++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("AbsenceComplaintsOfPatientsYes")->AsInteger != 0){
			AbsenceComplaintsOfPatientsYes += DMAvtoriz->DSInspection->DataSet->FieldByName("AbsenceComplaintsOfPatientsYes")->AsInteger;
			count8++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("TimelyRegistLNYes")->AsInteger != 0){
			TimelyRegistLNYes += DMAvtoriz->DSInspection->DataSet->FieldByName("TimelyRegistLNYes")->AsInteger;
			count9++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("RefferalToVKYes")->AsInteger != 0){
			RefferalToVKYes += DMAvtoriz->DSInspection->DataSet->FieldByName("RefferalToVKYes")->AsInteger;
			count10++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("IntegrityCard")->AsInteger != 0){
			IntegrityCard += DMAvtoriz->DSInspection->DataSet->FieldByName("IntegrityCard")->AsInteger;
			count11++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("AccuracyHandwriting")->AsInteger != 0){
			AccuracyHandwriting += DMAvtoriz->DSInspection->DataSet->FieldByName("AccuracyHandwriting")->AsInteger;
			count12++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("QualityProfInsOnko")->AsInteger != 0){
			QualityProfInsOnko += DMAvtoriz->DSInspection->DataSet->FieldByName("QualityProfInsOnko")->AsInteger;
			count13++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("DispTimelines")->AsInteger != 0){
			DispTimelines += DMAvtoriz->DSInspection->DataSet->FieldByName("DispTimelines")->AsInteger;
			count14++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("QualityCollectAnamsis")->AsInteger != 0){
			QualityCollectAnamsis += DMAvtoriz->DSInspection->DataSet->FieldByName("QualityCollectAnamsis")->AsInteger;
			count15++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("QualityCollectComplaint")->AsInteger != 0){
			QualityCollectComplaint += DMAvtoriz->DSInspection->DataSet->FieldByName("QualityCollectComplaint")->AsInteger;
			count16++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("DescriptObjectStatus")->AsInteger != 0){
			DescriptObjectStatus += DMAvtoriz->DSInspection->DataSet->FieldByName("DescriptObjectStatus")->AsInteger;
			count17++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("EvaluationResultsOfTreatment")->AsInteger != 0){
			EvaluationResultsOfTreatment += DMAvtoriz->DSInspection->DataSet->FieldByName("EvaluationResultsOfTreatment")->AsInteger;
			count18++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("ObservStandartsOfDiagnostics")->AsInteger != 0){
			ObservStandartsOfDiagnostics += DMAvtoriz->DSInspection->DataSet->FieldByName("ObservStandartsOfDiagnostics")->AsInteger;
			count19++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("ObservStandartsOfTreatment")->AsInteger != 0){
			ObservStandartsOfTreatment += DMAvtoriz->DSInspection->DataSet->FieldByName("ObservStandartsOfTreatment")->AsInteger;
			count20++;
		}
		if(DMAvtoriz->DSInspection->DataSet->FieldByName("DeadlinesVN")->AsInteger != 0){
			DeadlinesVN += DMAvtoriz->DSInspection->DataSet->FieldByName("DeadlinesVN")->AsInteger;
			count21++;
		}

		DMAvtoriz->DSInspection->DataSet->Next();
	}
	ShowMessage("Сбор отчета закончен!");
}
//---------------------------------------------------------------------------

