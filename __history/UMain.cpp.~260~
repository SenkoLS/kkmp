//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "UMain.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "DBAxisGridsEh"
#pragma link "DBGridEh"
#pragma link "DBGridEhGrouping"
#pragma link "DBGridEhToolCtrls"
#pragma link "DynVarsEh"
#pragma link "GridsEh"
#pragma link "ToolCtrlsEh"
#pragma resource "*.dfm"
TFMain *FMain;
//---------------------------------------------------------------------------
__fastcall TFMain::TFMain(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TFMain::FormShow(TObject *Sender)
{
	FAvtoriz->ShowModal();
	DMAvtoriz->SQLQInspection->Open();
	DMAvtoriz->CDSInspection->Open();
	//AnsiString strYear = FormatDateTime("yyyy",Now().CurrentDateTime());
	DateTimePickerStart->Date = Now(); //StrToDate(strcat("01.01.",strYear.c_str()));
	DateTimePickerEnd->Date = Now();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::N3Click(TObject *Sender)
{
	FAbout->ShowModal();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::N4Click(TObject *Sender)
{
	FDictionaryMed->ShowModal();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::NewCardClick(TObject *Sender)
{
	FCard->ShowModal();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::DBGridEh1KeyDown(TObject *Sender, WORD &Key, TShiftState Shift)
{
	switch(Key){
    	case 113: FCard->ShowModal(); break;
	}
}
//---------------------------------------------------------------------------
void __fastcall TFMain::N6Click(TObject *Sender)
{
	FCatalogOffices->ShowModal();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::FormClose(TObject *Sender, TCloseAction &Action)
{
	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->CDSInspection->Close();
	DMAvtoriz->SQLConnectKKMP->Close();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::DBGridEh1DblClick(TObject *Sender)
{
	//Set card number for editing in FCard
	FCard->id_inspection = DBGridEh1->DataSource->DataSet->FieldByName("id_inspection")->AsInteger;
	FCard->id_expert = DBGridEh1->DataSource->DataSet->FieldByName("id_expert")->AsInteger;
	if(FCard->id_inspection == 0) return;
	FCard->ShowModal();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::BDeleteCardClick(TObject *Sender)
{
	if(DBGridEh1->DataSource->DataSet->FieldByName("id_inspection")->AsInteger == 0) return;

	if(DMAvtoriz->DSAvtoriz->DataSet->FieldByName("login")->AsAnsiString != "admin"){
		if(	DBGridEh1->DataSource->DataSet->FieldByName("id_expert")->AsInteger
		!= DMAvtoriz->DSAvtoriz->DataSet->FieldByName("id_user")->AsInteger){

			MessageBox(0,L"Вы не заносили эту карту!\nУ вас нет прав на данную операцию!",L"Сообщение",MB_OK);
			return;
		}
	}

	int mess = MessageBox(0,L"Вы хотите удалить выбранную запись?",L"Предупреждение",MB_YESNO);
	if(mess != 6) return;

	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->SQLQInspection->SQL->Text =
		"DELETE FROM `inspection` WHERE `id_inspection` = '"
		+ DBGridEh1->DataSource->DataSet->FieldByName("id_inspection")->AsAnsiString +"'";
	try{
		DMAvtoriz->SQLConnectKKMP->StartTransaction(trans);
		if(DMAvtoriz->SQLQInspection->ExecSQL()){
			DMAvtoriz->SQLConnectKKMP->Commit(trans);
		}else{
			DMAvtoriz->SQLConnectKKMP->Rollback(trans);
			MessageBox(0,L"Запрос вернул \"false\"!\nОбратитесь к разработчику.",L"Ошибка удаления",MB_OK);
		}
	}catch(Exception &e){
		DMAvtoriz->SQLConnectKKMP->Rollback(trans);
		MessageBox(0,e.Message.c_str(),L"Ошибка удаления",MB_OK);
	}

	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->SQLQInspection->SQL->Text =
		"SELECT `id_inspection`,`date_start`,`date_end`,`duration`,CONCAT(`surname`,' ',`name`,' ',`patronymic`) as `fio`,"
		"`year_date_birthday`,`id_user`,`kkmp`,`kvo`,`id_expert` "
		"FROM `inspection` "
		"WHERE `date_start` BETWEEN CONCAT(YEAR(NOW()),'-01-01') AND NOW() "
		"ORDER BY `id_inspection` DESC";

	DMAvtoriz->SQLQInspection->Open();
	DMAvtoriz->CDSInspection->Close();
	DMAvtoriz->CDSInspection->Open();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::BShowCardClick(TObject *Sender)
{
	DBGridEh1DblClick(Sender);
}
//---------------------------------------------------------------------------
void __fastcall TFMain::BShowAllClick(TObject *Sender)
{
	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->SQLQInspection->SQL->Text =
		"SELECT `id_inspection`,`date_start`,`date_end`,`duration`,CONCAT(`surname`,' ',`name`,' ',`patronymic`) as `fio`,"
		"`year_date_birthday`,`id_user`,`kkmp`,`kvo`,`id_expert` "
		"FROM `inspection` "
		"WHERE `date_start` BETWEEN CONCAT(YEAR(NOW()),'-01-01') AND NOW() "
		"ORDER BY `id_inspection` DESC";

	DMAvtoriz->SQLQInspection->Open();
	DMAvtoriz->CDSInspection->Close();
	DMAvtoriz->CDSInspection->Open();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::BSortFioClick(TObject *Sender)
{
	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->SQLQInspection->SQL->Text =
		"SELECT `id_inspection`,`date_start`,`date_end`,`duration`,CONCAT(`surname`,' ',`name`,' ',`patronymic`) as `fio`,"
		"`year_date_birthday`,`id_user`,`kkmp`,`kvo`,`id_expert` "
		"FROM `inspection` "
		"WHERE `date_start` BETWEEN CONCAT(YEAR(NOW()),'-01-01') AND NOW() "
		"ORDER BY `fio` ASC";

	DMAvtoriz->SQLQInspection->Open();
	DMAvtoriz->CDSInspection->Close();
	DMAvtoriz->CDSInspection->Open();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::BSortDurationClick(TObject *Sender)
{
	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->SQLQInspection->SQL->Text =
		"SELECT `id_inspection`,`date_start`,`date_end`,`duration`,CONCAT(`surname`,' ',`name`,' ',`patronymic`) as `fio`,"
		"`year_date_birthday`,`id_user`,`kkmp`,`kvo`,`id_expert` "
		"FROM `inspection` "
		"WHERE `date_start` BETWEEN CONCAT(YEAR(NOW()),'-01-01') AND NOW() "
		"ORDER BY `duration` ASC";

	DMAvtoriz->SQLQInspection->Open();
	DMAvtoriz->CDSInspection->Close();
	DMAvtoriz->CDSInspection->Open();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::BSortDateEndClick(TObject *Sender)
{
	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->SQLQInspection->SQL->Text =
		"SELECT `id_inspection`,`date_start`,`date_end`,`duration`,CONCAT(`surname`,' ',`name`,' ',`patronymic`) as `fio`,"
		"`year_date_birthday`,`id_user`,`kkmp`,`kvo`,`id_expert` "
		"FROM `inspection` "
		"WHERE `date_start` BETWEEN CONCAT(YEAR(NOW()),'-01-01') AND NOW() "
		"ORDER BY `date_end` ASC";

	DMAvtoriz->SQLQInspection->Open();
	DMAvtoriz->CDSInspection->Close();
	DMAvtoriz->CDSInspection->Open();
}
//---------------------------------------------------------------------------
void __fastcall TFMain::DateTimePickerStartChange(TObject *Sender)
{
	DMAvtoriz->SQLQInspection->Close();
	DMAvtoriz->SQLQInspection->SQL->Text =
		"SELECT `id_inspection`,`date_start`,`date_end`,`duration`,CONCAT(`surname`,' ',`name`,' ',`patronymic`) as `fio`,"
		"`year_date_birthday`,`id_user`,`kkmp`,`kvo`,`id_expert` "
		"FROM `inspection` "
		"WHERE `date_start` BETWEEN '"+ FormatDateTime("yyyy-mm-dd",DateTimePickerStart->DateTime) +"' AND '"+ FormatDateTime("yyyy-mm-dd",DateTimePickerEnd->DateTime) +"' "
		"ORDER BY `id_inspection` DESC";

	DMAvtoriz->SQLQInspection->Open();
	DMAvtoriz->CDSInspection->Close();
	DMAvtoriz->CDSInspection->Open();
}
//---------------------------------------------------------------------------

void __fastcall TFMain::DateTimePickerEndChange(TObject *Sender)
{
 	DateTimePickerStartChange(Sender);
}
//---------------------------------------------------------------------------

void __fastcall TFMain::DBLCBoxFindMedEnter(TObject *Sender)
{
	DMAvtoriz->SQLQGetListMed->Open();
	DMAvtoriz->CDSGetListMed->Open();
}
//---------------------------------------------------------------------------

void __fastcall TFMain::DBLCBoxFindExpertEnter(TObject *Sender)
{
	DMAvtoriz->SQLQGetListMed->Open();
	DMAvtoriz->CDSGetListMed->Open();
}
//---------------------------------------------------------------------------

void __fastcall TFMain::DBLCBoxFindOfficeEnter(TObject *Sender)
{
	DMAvtoriz->SQLQgetListOffice->Open();
	DMAvtoriz->CDSgetListOffice->Open();
}
//---------------------------------------------------------------------------

void __fastcall TFMain::BPrintProtocolClick(TObject *Sender)
{
	int mess = MessageBox(0,L"Вы хотите распечатать протокол в EXCEL?",L"Сообщение",MB_YESNO);
	if(mess != 6) return;

	Variant  vVarApp,vVarBooks,vVarBook, vVarSheets,vVarSheet,vVarCell;
	UnicodeString dir_cards;
	AnsiString dir;

	if(SelectDirectory("Выберите папку для сохранения протокола:","",dir_cards)){
		dir = dir_cards+"\\";
		dir = dir + "ПРОТОКОЛ КАРТЫ.xls";
	}

	try{
		vVarApp=CreateOleObject("Excel.Application");
		vVarApp.OlePropertySet("Visible",true);
		vVarBooks=vVarApp.OlePropertyGet("Workbooks");
		vVarApp.OlePropertySet("SheetsInNewWorkbook",2);
		vVarBooks.OleProcedure("Add");
		vVarBook=vVarBooks.OlePropertyGet("Item",1);
		vVarSheets=vVarBook.OlePropertyGet("Worksheets") ;
	}catch(Exception &e){
		MessageBox(0,e.Message.c_str(),L"Ошибка создания EXCEL:",MB_OK);
		return;
	}

		//----- GET DATA THE CURRENT CARD---------------------------------------
		DMAvtoriz->SQLQInspection->Close();
		DMAvtoriz->SQLQInspection->SQL->Text =
			"SELECT `inspection`.`id_inspection`,`inspection`.`date_start`,"
			"`inspection`.`date_end`,`inspection`.`duration`,"
			"CONCAT(`inspection`.`surname`,' ',`inspection`.`name`,' ',`inspection`.`patronymic`) as `fio_pac`,"
			"`inspection`.`year_date_birthday`,"
			"`inspection`.`area`,`inspection`.`id_user`,"
			"`inspection`.`RemarkInfServYes`,`inspection`.`RemarkAnamYes`,"
			"`inspection`.`RemarkFizResYes`,`inspection`.`ResearchNotYes`,"
			"`inspection`.`ResearchToMuchYes`,`inspection`.`ResearchLateYes`,"
			"`inspection`.`ResearchInstrNotYes`,`inspection`.`ResearchInstrToMuchYes`,"
			"`inspection`.`ResearchInstrLateYes`,`inspection`.`RemarkKonsultNotYes`,"
			"`inspection`.`RemarkKonsultLateYes`,`inspection`.`RemarkDeseaseVerifYes`,"
			"`inspection`.`RemarkDeseaseTimeYes`,`inspection`.`RemarkDeseaseContentYes`,"
			"`inspection`.`RemarkTherapyChooseDrYes`,`inspection`.`RemarkTherapyTimeAppointmentYes`,"
			"`inspection`.`RemarkTherapyPolypharmacyYes`,`inspection`.`ContinuityChoosePlaceYes`,"
			"`inspection`.`ContinuityTimeTransferYes`,`inspection`.`RemarkStandartMHYes`,"
			"`inspection`.`VuluntarMedAgreementYes`,`inspection`.`AgreementPDNYes`,"
			"`inspection`.`ComplitListDeseaseYes`,`inspection`.`CompitListProfAndStatusYes`,"
			"`inspection`.`ExistenceFLGYes`,`inspection`.`ExistenceInspGinYes`,"
			"`inspection`.`RationalUseOfResourcesYes`,`inspection`.`AbsenceComplaintsOfPatientsYes`,"
			"`inspection`.`TimelyRegistLNYes`,`inspection`.`RefferalToVKYes`,"
			"`inspection`.`IntegrityCard`,`inspection`.`AccuracyHandwriting`,"
			"`inspection`.`QualityProfInsOnko`,`inspection`.`DispTimelines`,"
			"`inspection`.`QualityCollectAnamsis`,`inspection`.`QualityCollectComplaint`,"
			"`inspection`.`DescriptObjectStatus`,`inspection`.`EvaluationResultsOfTreatment`,"
			"`inspection`.`ObservStandartsOfDiagnostics`,`inspection`.`ObservStandartsOfTreatment`,"
			"`inspection`.`DeadlinesVN`,`inspection`.`kkmp`,"
			"`inspection`.`kvo`,`inspection`.`id_expert`,"
			"`user`.`id_user` as `id_user_expert`,`user`.`login`,"
			"CONCAT(`user`.`surname`,' ',`user`.`name`,' ',`user`.`patronymic`) as `fio_expert`,"
			"`user`.`id_office` "
		"FROM `inspection` INNER JOIN `user` "
		"ON `inspection`.`id_expert` = `user`.`id_user` "
		"WHERE `id_inspection` = '" + DBGridEh1->DataSource->DataSet->FieldByName("id_inspection")->AsAnsiString + "'";

		DMAvtoriz->SQLQInspection->Open();
		DMAvtoriz->CDSInspection->Close();
		DMAvtoriz->CDSInspection->Open();
		//----------------------------------------------------------------------

		//FIRST LIST (KKMP)
		vVarSheet=vVarSheets.OlePropertyGet("Item",1);
		vVarSheet.OlePropertySet("Name","KKMP");
		vVarCell=vVarSheet.OlePropertyGet("Range","A1:D1");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Протокол оценки качества оказания медицинской помощи пациенту(ки)  I уровень.");
		//3
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",3,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Врач:");
		vVarCell.OlePropertySet("ColumnWidth", 15);
		//4
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",4,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "ФИО пациента:");

        vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",4,2);
		vVarCell.OlePropertySet("ColumnWidth", 50);

		vVarCell=vVarSheet.OlePropertyGet("Range","B4:D4");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("Value", DMAvtoriz->DSInspection->DataSet->FieldByName("fio_pac")->AsAnsiString.c_str());
        vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);
		//5

		//6
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",6,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "№ п/п");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",6,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Критерии оценки");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",6,3);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Оценка");
		vVarCell.OlePropertySet("ColumnWidth", 15);

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",6,4);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Итого");
		vVarCell.OlePropertySet("ColumnWidth", 15);
		//7
		vVarCell=vVarSheet.OlePropertyGet("Range","A7:D7");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertyGet("Interior").OlePropertySet("Color",0xF0F8FF);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Качество ведения медицинской документации");
		//8
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",8,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "1");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",8,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Наличие добровольного медицинского согласия");
		//9
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",9,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "2");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",9,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Наличие согласия пациента на обработку персональных данных");
		//10
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",10,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "3");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",10,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Заполнение листа уточненных диагнозов");
		//11
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",11,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "4");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",11,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Заполнение графы профессия и социальный статус");
		//12
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",12,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "5");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",12,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Целостность карты");
		//13
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",13,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "6");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",13,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Почерк, аккуратность заполнения");
		//14
		vVarCell=vVarSheet.OlePropertyGet("Range","A14:D14");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertyGet("Interior").OlePropertySet("Color",0xF0F8FF);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Качество оказания медицинской помощи");
		//15
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",15,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "7");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",15,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Наличие ФЛГ (результатов или направления)");
		//16
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",16,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "8");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",16,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Наличие осмотров гениколога (результатов или направления)");
		//17
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",17,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "9");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",17,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Качество проведения проф. окнологического осмотра");
		//18
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",18,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "10");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",18,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Диспансеризация (своевременность и качество)");
		//19
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",19,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "11");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",19,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Качество сбора анамнеза");
		//20
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",20,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "12");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",20,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Качество сбора жалоб");
		//21
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",21,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "13");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",21,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Описание объективного статуса");
		//22
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",22,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "14");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",22,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Оценка результатов лечения");
		//23
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",23,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "15");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",23,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Соблюдение стандартов в диагностике");
		//24
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",24,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "16");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",24,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Соблюдение стандартов в лечении");
		//25
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",25,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "17");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",25,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Рациональность использования ресурсов");
		//26
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",26,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "18");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",26,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Отсутствие жалоб пациента");
		//27
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",27,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "19");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",27,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Соблюдение сроков ВН (при наличии)");
		//28
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",28,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "20");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",28,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Своевременность оформления ЛН (при наличии)");
		//29
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",29,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "21");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",29,2);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Своевременность направления на ВК (при наличии)");

		//-----IN TOTAL---------------------------------------------------------

		//FOR 8-13
		vVarCell=vVarSheet.OlePropertyGet("Range","D8:D13");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "0.254");

		//FOR 15-29
		//FOR 8-13
		vVarCell=vVarSheet.OlePropertyGet("Range","D15:D29");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "0.165");

		vVarCell=vVarSheet.OlePropertyGet("Range","A30:B30");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "ИТОГО:");
		//30
		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",30,4);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "=D8&\" / \"&D15");

		//-----END OF IN TOTAL--------------------------------------------------

		//BORDER:
		vVarCell = vVarSheet.OlePropertyGet("Range","A6:D30").OlePropertyGet("Borders");
		vVarCell.OlePropertySet("LineStyle", 1);

		//33
		vVarCell=vVarSheet.OlePropertyGet("Range","A33:D33");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		vVarCell.OlePropertySet("Value", "Выводы и предложения:");

		vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);
		//34
		vVarCell=vVarSheet.OlePropertyGet("Range","A34:D34");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);

		vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);
		//35
		vVarCell=vVarSheet.OlePropertyGet("Range","A35:D35");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);

		vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);
		//36
		vVarCell=vVarSheet.OlePropertyGet("Range","A36:D36");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);

		vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);
		//37
		vVarCell=vVarSheet.OlePropertyGet("Range","A37:D37");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);

		vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);

		//39
		vVarCell=vVarSheet.OlePropertyGet("Range","A39:C39");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",2);
		AnsiString str = "Эксперт I уровня, заведующий отделением: " + DMAvtoriz->DSInspection->DataSet->FieldByName("fio_expert")->AsAnsiString;
		vVarCell.OlePropertySet("Value", str.c_str());

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",39,4);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",4);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
        vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);

		DMAvtoriz->SQLQInspection->Close();
		DMAvtoriz->SQLQInspection->SQL->Text =
			"SELECT CONCAT(`inspection`.`surname`,' ',`inspection`.`name`,' ',`inspection`.`patronymic`) as `fio_med` FROM `inspection` INNER JOIN `user` "
			"ON `inspection`.`id_user` = `user`.`id_user` "
			"WHERE `id_inspection` = '" + DBGridEh1->DataSource->DataSet->FieldByName("id_inspection")->AsAnsiString + "'";
		DMAvtoriz->SQLQInspection->Open();
		DMAvtoriz->CDSInspection->Close();
		DMAvtoriz->CDSInspection->Open();

		vVarCell=vVarSheet.OlePropertyGet("Range","B3:D3");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("Value", DMAvtoriz->DSInspection->DataSet->FieldByName("fio_med")->AsAnsiString.c_str());
        vVarCell = vVarCell.OlePropertyGet("Borders",9);
		vVarCell.OlePropertySet("LineStyle", 1);

		//SECOND LIST (KVO)
		vVarSheet=vVarSheets.OlePropertyGet("Item",2);
		vVarSheet.OlePropertySet("Name","KVO");
		vVarCell=vVarSheet.OlePropertyGet("Range","A2:D2");
		vVarCell.OleProcedure("Merge");
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Протокол оценки врачебных ошибок при оказания МП пациенту(ки)  I уровень.");

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",3,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "Врач:");
		vVarCell.OlePropertySet("ColumnWidth", 15);

		vVarCell = vVarSheet.OlePropertyGet("Cells").OlePropertyGet("Item",4,1);
		vVarCell.OlePropertySet("WrapText", true);
		vVarCell.OlePropertySet("HorizontalAlignment",-4108);
		vVarCell.OlePropertySet("VerticalAlignment",-4108);
		vVarCell.OlePropertySet("Value", "ФИО пациента:");

		//BORDER:
		vVarCell = vVarSheet.OlePropertyGet("Range","A6:D35").OlePropertyGet("Borders");
		vVarCell.OlePropertySet("LineStyle", 1);

        //СОХРАНЕНИЕ В КАТАЛОГ:
		vVarApp.OlePropertyGet("Workbooks").OlePropertyGet("Item",1).OleProcedure("SaveAs",dir.c_str());
		//vVarApp.OleProcedure("Quit");



		MessageBox(0, L"Выгрузка карт закончена.", L"Сообщение", MB_OK);
}
//---------------------------------------------------------------------------

